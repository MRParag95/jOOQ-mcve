package org.jooq.mcve.test.java.postgres;

import org.jooq.Condition;
import org.jooq.DSLContext;
import org.jooq.SQLDialect;
import org.jooq.conf.RenderImplicitJoinType;
import org.jooq.conf.Settings;
import org.jooq.impl.DSL;
import org.jooq.mcve.java.postgres.tables.records.TestRecord;
import org.jooq.tools.JooqLogger;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.utility.ResourceReaper;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Properties;

import static org.jooq.impl.DSL.*;
import static org.jooq.mcve.java.postgres.Tables.*;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;

public class JavaTest {

    static JooqLogger             log = JooqLogger.getLogger(JavaTest.class);
    static PostgreSQLContainer<?> db;
    static Connection             connection;
    static DSLContext             ctx;

    @BeforeClass
    public static void init() throws SQLException {
        if (System.getProperty("jooq.codegen.jdbc.url") == null) {
            db = new org.testcontainers.containers.PostgreSQLContainer<>("postgres:latest")
                 .withUsername("postgres")
                 .withDatabaseName("postgres")
                 .withPassword("postgres")
                 .withInitScript("db/migration/init.sql");

            db.start();
            System.setProperty("jooq.codegen.jdbc.url", db.getJdbcUrl());
            System.setProperty("jooq.codegen.jdbc.username", db.getUsername());
            System.setProperty("jooq.codegen.jdbc.password", db.getPassword());
        }

        Properties properties = new Properties();
        properties.setProperty("username", "postgres");
        properties.setProperty("password", "postgres");

        log.info("Connecting");
        connection = DriverManager.getConnection(
            System.getProperty("jooq.codegen.jdbc.url"),
            System.getProperty("jooq.codegen.jdbc.username"),
            System.getProperty("jooq.codegen.jdbc.password")
        );

        Settings settings = new Settings()
                .withRenderImplicitJoinType( RenderImplicitJoinType.LEFT_JOIN)
                .withRenderImplicitJoinToManyType(RenderImplicitJoinType.LEFT_JOIN);

        ctx = DSL.using(connection, SQLDialect.POSTGRES, settings);

        // Use JDBC directly instead of jOOQ to avoid DEBUG logging all of this
        try (Statement s = connection.createStatement()) {
            log.info("Finished setup");
        }
    }

    @AfterClass
    public static void end() {
        if (db != null) {
            ResourceReaper.instance().stopAndRemoveContainer(db.getContainerId(), db.getDockerImageName());
        }
    }

    @Before
    public void setup() throws Exception {
        ctx.delete(TEST).execute();
    }

    @After
    public void after() throws Exception {
    }

    @Test
    public void mcveTest() {
        assertEquals(1,
            ctx.insertInto(TEST)
               .columns(TEST.CD)
               .values(42)
               .execute()
        );

        TestRecord record = ctx.fetchOne(TEST, TEST.CD.eq(42));
        assertNotNull(record.getId());
    }

    @Test
    public void implicitJoinBug() {
        Boolean isAdmin = false;
        Boolean fromSafetyManagementDepartment = false;

        List< Condition > finalQueryConditions = new ArrayList<>( );

        var meetingMinuteTable = MEETING_MINUTES;
        var safetyOfficialTable = meetingMinuteTable.safetyOfficial( );
        var meetingAttendanceTable = meetingMinuteTable.meetingAttendance( );
        var meetingAgendaTable = meetingMinuteTable.meetingAgenda( );
        var meetingDecisionTable = meetingMinuteTable.meetingAgenda( ).meetingDecision( );
        var meetingDecisionActionByTable = meetingMinuteTable.meetingAgenda( ).meetingDecision( ).meetingDecisionActionBy( );
        var meetingSagHeadEmpTable = meetingMinuteTable.meetingSagHeadEmp( );

        var employeeSafetyOfficialsTable = EMPLOYEE_SAFETY_OFFICIALS.as( "employeeSafetyOfficialsTable" );

        finalQueryConditions.add( meetingMinuteTable.MEETING_DATE.cast( Instant.class ).between( Instant.now().minus( 10, ChronoUnit.DAYS ), Instant.now() ) );

        finalQueryConditions.add( meetingMinuteTable.IS_ACTIVE.isTrue( ) );

        User currentUser = new User( 1L );

        if ( !isAdmin && !fromSafetyManagementDepartment ) {
            finalQueryConditions.add(
                    meetingDecisionActionByTable.ID.eq( currentUser.getId() )
                            .or( meetingAttendanceTable.fk45wm9ak3urnj55wmt7bpdilag( ).ID.eq( currentUser.getId( ) ) )
                            .or( safetyOfficialTable.employeeSafetyOfficials().fkrc0334eor9ddu84fee889e2wt().ID.eq( currentUser.getId( ) ) )
            );
        }

        var isSagHead = exists(
                selectOne( )
                        .from( meetingMinuteTable )
                        .where( meetingMinuteTable.safetyOfficial( ).employeeSafetyOfficials( ).EMPLOYEE_ID.eq( currentUser.getId( ) ) )
                        .and( meetingMinuteTable.safetyOfficial( ).employeeSafetyOfficials( ).POSITION.eq( ManagerialPosition.SAG_HEAD.name( ) ) )
        );

        var isHosm = exists(
                selectOne( )
                        .from( employeeSafetyOfficialsTable )
                        .where( employeeSafetyOfficialsTable.EMPLOYEE_ID.eq( currentUser.getId( ) ) )
                        .and( employeeSafetyOfficialsTable.POSITION.eq( ManagerialPosition.HOSM.name( ) ) )
        );

        var isDeputyHosm = exists(
                selectOne( )
                        .from( employeeSafetyOfficialsTable )
                        .where( employeeSafetyOfficialsTable.EMPLOYEE_ID.eq( currentUser.getId( ) ) )
                        .and( employeeSafetyOfficialsTable.POSITION.eq( ManagerialPosition.DEPUTY_HOSM.name( ) ) )
        );

        var isAccountableManager = exists(
                selectOne( )
                        .from( employeeSafetyOfficialsTable )
                        .where( employeeSafetyOfficialsTable.EMPLOYEE_ID.eq( currentUser.getId( ) ) )
                        .and( employeeSafetyOfficialsTable.POSITION.eq( ManagerialPosition.ACCOUNTABLE_MANAGER.name( ) ) )
        );

        var hasReviewAuthority = case_( )
                .when(
                        meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAG_MONTHLY.getAbbreviation( ) )
                                .and( isSagHead ),
                        true
                )
                .when(
                        (
                                meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SRB_REVIEW.getAbbreviation( ) )
                                        .or( meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAFETY_SEMINAR.getAbbreviation( ) ) )
                        )
                                .and( isHosm.or( isDeputyHosm ) ),
                        true
                )
                .when(
                        meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAG_COORDINATION.getAbbreviation( ) )
                                .and( isDeputyHosm ),
                        true
                )
                .otherwise( false );

        var hasApproveAuthority = case_( )
                .when(
                        (
                                meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAG_MONTHLY.getAbbreviation( ) )
                                        .or( meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAG_COORDINATION.getAbbreviation( ) ) )
                        )
                                .and( isHosm.or( isDeputyHosm ) ),
                        true
                )
                .when(
                        (
                                meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SRB_REVIEW.getAbbreviation( ) )
                                        .or( meetingMinuteTable.meetingType( ).ABBREVIATION.equalIgnoreCase( DefaultMeetingType.SAFETY_SEMINAR.getAbbreviation( ) ) )
                        )
                                .and( isAccountableManager.or( isHosm ) ),
                        true
                )
                .otherwise( false );

        var authorityTableCTE = name( "authorityTableCTE" ).as(
                select(
                        meetingMinuteTable.ID.as( "id" ),
                        case_( )
                                .when(
                                        meetingMinuteTable.MEETING_APPROVAL_STATUS.isNull( ),
                                        hasReviewAuthority
                                )
                                .when( meetingMinuteTable.MEETING_APPROVAL_STATUS.isNotNull( ).and( meetingMinuteTable.MEETING_APPROVAL_STATUS.equalIgnoreCase( MeetingApprovalStatus.REVIEWED.name( ) ) ), hasApproveAuthority )
                                .otherwise( false )
                                .as( "hasApprovalAuthority" )
                )
                        .from( meetingMinuteTable )
        );

        var finalQuery = ctx
                .with( authorityTableCTE )
                .select(
                        authorityTableCTE.field( "hasApprovalAuthority" ).as( "hasApprovalAuthority" )

                )
                .distinctOn( meetingMinuteTable.ID )
                .from( meetingMinuteTable )
                .leftJoin( authorityTableCTE ).on( authorityTableCTE.field( "id", Long.class ).eq( meetingMinuteTable.ID ) )
                .where( finalQueryConditions )
                .orderBy( meetingMinuteTable.ID.desc( ) );

        finalQuery.fetch();
    }
}

class User {
    private Long id;

    public User( Long id ) {
        this.id = id;
    }

    public Long getId( ) {
        return id;
    }

    public void setId( Long id ) {
        this.id = id;
    }
}

enum ManagerialPosition {
    SAG_HEAD, HOSM, DEPUTY_HOSM, ACCOUNTABLE_MANAGER
}

enum DefaultMeetingType {
    SAG_MONTHLY, SRB_REVIEW, SAFETY_SEMINAR, SAG_COORDINATION;

    public String getAbbreviation() {
        return name().toLowerCase();
    }
}

enum MeetingApprovalStatus {
    REVIEWED, APPROVED
}